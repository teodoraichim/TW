<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/projects.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:500&display=swap" rel="stylesheet">
    <title>Code</title>
</head>

<body>
    <div id="left" class="column">
        <div class="top-left">
            <ul>
                <li><img src="img/user.svg">
                </li>
            </ul>
        </div>
        <div class="bottom">
            <ul>
                <a id="project" href="projects.html">
                    <li>Project</li>
                </a>
                <a id="table" href="#">
                    <li>Table</li>
                </a>
                <div class="table">
                    <div id="additional-links">
                        <a href="newtable.html">
                            <li>New table</li>
                        </a><a href="viewtables.html">
                            <li>View tables</li>
                        </a>
                    </div>
                </div>
                <a id="query" href="singlecoding.html">
                    <li>Query</li>
                </a>
            </ul>
        </div>
    </div>
    <div id="right" class="column">
        <div class="top-right">
            <p>
                <br>
            </p>
        </div>
        <div class="bottom">
            <div class="addproject">
                <form>
                    <input type="text" placeholder="Project name" name="addproject" required="" id="projectName">
                    <input type="text" placeholder="Username" name="addproject" required="" id="userName">
                    <input type="text" placeholder="Password" name="addproject" required="" id="passs">
                    <input type="text" placeholder="Collaborator" name="collaborator" id="userColab">
                </form>
                <button class="addbutton" id="addbutton">Create</button>
                <button class="addbutton" id="deletebutton">Delete</button>
                <button class="addbutton" id="addcollaborator">Add collaborator</button>
                <button class="addbutton" id="seecollaborators">See collaborators</button>
                
            </div>
            <div id="projectslist">
            </div>
        </div>
    </div>

    <script>

        //let jwt = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJpYXQiOjE1NjAyODE2MjgsImV4cCI6MTU2MDMyNDgyOCwiYXVkIjoiaHR0cDovL2xvY2FsaG9zdCIsImlzcyI6IlVQTlAiLCJzdWIiOiJzb21lQHVzZXIuY29tIn0.P1PJEuW3LKBOPXVyNUUyI5MuYGAqh236jL2r85EN7ZqGnwPcSGXXTIS3eOeb-n6c7f2OKv1FaiviDAAOCEE7jg";
        let jwt =localStorage.getItem("jwt");
        let seeCollab = document.getElementById("seecollaborators");
        function getProjectListFetch(jwt) {
            let bearer = 'Bearer ' + jwt;
            fetch("http://192.168.1.8:8000/projects", {
                method: 'GET',
                headers: {
                    authorization: bearer,

                }

            }).then((resp) => {
                if (resp.status == 200) { return resp.json(); }
                else if (resp.status == 500) { console.log("500"); }
                else if (resp.status = 401) { console.log("401"); }

            }).then(jsonResp => {
                if (jsonResp) {
                    console.log(jsonResp);
                    jsonResp["projects"].forEach(element => {
                        console.log(element.project_name);
                        console.log(element.project_id);
                        myFunction(element.project_name, element.project_id);
                        //console.log(element);

                    });
                }


            })
        }
        getProjectListFetch(jwt);




        

        let projcount = 0;
        let clicked = "false";

        let content = document.getElementById("additional-links");
        content.hidden = true;
        let table = document.getElementById("table");
        const style = getComputedStyle(content);
        table.addEventListener("click",
            function () {
                if (style.display == "block")
                    content.hidden = true;
                else
                    content.hidden = false;
            }, false);

        let button = document.getElementById("addbutton");
        let deleteB = document.getElementById("deletebutton");
        let addCollabB = document.getElementById("addcollaborator");
        //  button.addEventListener('click', myFunction);
        button.addEventListener('click', dataSaver);

        function dataSaver() {
            let pN = document.getElementById("projectName").value;
            let uN = document.getElementById("userName").value;
            let pS = document.getElementById("passs").value;
            console.log(pN, uN, pS)
            addProject(jwt, pN, uN, pS);
        }
        function addProject(jwt, projectName, username, password) {
            let pN = document.getElementById("projectName").value;
            let query = "http://192.168.1.8:8000/projects?project_name=" + projectName + "&username=" + username + "&password=" + password;
            let bearer = 'Bearer ' + jwt;
            fetch(query, {
                method: 'POST',
                // withCredentials: true,
                // credentials: 'include',
                // mode:"no-cors",
                headers: {
                    'Authorization': bearer,
                    // 'Content-Type': 'application/json'
                }
            }).then((resp) => {
                if (resp.status == 200) { return resp.json(); }
                else if (resp.status == 500) { console.log("500"); }
                else if (resp.status = 401) { console.log("401"); }
                else if (resp.status = 403) { console.log("403"); }

            }).then((jsonResp) => {
                if (jsonResp) {
                    console.log(jsonResp);
                    myFunction(pN, jsonResp["projects_id"]);
                }
            })
        }
        function myFunction(name, id) {
            var para = document.createElement("DIV");
            para.className += "projectview";
            para.id = projcount++;
            para.dataset.id = id;
            //console.log(para.dataset.id=id);
            para.innerHTML = name;
            document.getElementById("projectslist").appendChild(para);
            let activeproject = document.getElementsByClassName("projectview");
            // console.log(activeproject.length);
            for (i = 0; i < activeproject.length; i++) {
                let acproj = document.getElementById(i);
                acproj.addEventListener("click", function () {
                    if (clicked == "false") {
                        acproj.style.backgroundColor = "yellow";
                        acproj.style.color = "black";
                        clicked = "true";
                        let id = acproj.dataset.id;

                        localStorage.setItem("selected", i);
                        console.log(localStorage.getItem("selected"));
                        deleteB.addEventListener("click", function () {
                            let query = "http://192.168.1.8:8000/projects?project_id=" + id;
                            let bearer = 'Bearer ' + jwt;
                            fetch(query, {
                                method: 'DELETE',
                                // withCredentials: true,
                                // credentials: 'include',
                                // mode:"no-cors",
                                headers: {
                                    'Authorization': bearer,
                                    // 'Content-Type': 'application/json'
                                }
                            }).then((resp) => {
                                if (resp.status == 200) { console.log("Ok"); }
                                else if (resp.status == 500) { console.log("500"); }
                                else if (resp.status = 401) { console.log("401"); }

                            });
                            acproj.parentNode.removeChild(acproj);

                        });
                        addCollabB.addEventListener("click", function () {
                            let uC = document.getElementById("userColab").value;
                            console.log(uC);
                            let query = "http://192.168.1.8:8000/projects/colabs?project_id=" + id + "&user_id=" + uC;
                            let bearer = 'Bearer ' + jwt;
                            fetch(query, {
                                method: 'POST',
                                // withCredentials: true,
                                // credentials: 'include',
                                // mode:"no-cors",
                                headers: {
                                    'Authorization': bearer,
                                    // 'Content-Type': 'application/json'
                                }
                            }).then((resp) => {
                                if (resp.status == 200) { console.log(uC); }
                                else if (resp.status == 500) { console.log("500"); }
                                else if (resp.status = 401) { console.log("401"); }
                                else if (resp.status = 403) { console.log("403"); }

                            });
                        });
                        seeCollab.addEventListener("click", function () {
                            let query = "http://192.168.1.8:8000/projects/" + id;
                            let bearer = 'Bearer ' + jwt;
                            fetch(query, {
                                method: 'GET',
                                // withCredentials: true,
                                // credentials: 'include',
                                // mode:"no-cors",
                                headers: {
                                    'Authorization': bearer,
                                    // 'Content-Type': 'application/json'
                                }
                            }).then((resp) => {
                                if (resp.status == 200) { return resp.json(); }
                                else if (resp.status == 500) { console.log("500"); }
                                else if (resp.status = 401) { console.log("401"); }
                                else if (resp.status = 403) { console.log("403"); }

                            }).then(jsonResp => {
                                if (jsonResp) {
                                    let col='';
                                    console.log(jsonResp);
                                    jsonResp["colabs"].forEach(element => {
                                        console.log(element.user_id);
                                        col=col+" "+element.user_id;

                                    });
                                    alert(col);
                                }

                            })
                        })
                    }

                });


            }
        }

        id = localStorage.getItem("selected");
    //console.log(id);





    </script>

</body>

</html>ss